<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <title>ARK Identifiers</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <style>
        body {
            font: 80% Verdana, Tahoma, Arial, sans-serif;
        }

        h1, h2, h3, h4 {
            font-family: "Trebuchet MS", Georgia, "Times New Roman", serif;
        }

        ul.toc {
            padding: 4px;
            margin-left: 0;
        }

        ul.toc li {
            list-style-type: none;
        }

        ul.toc li.heading2 {
            margin-left: 1em;
        }

        ul.toc li.heading3 {
            margin-left: 2em;
        }

        a.wiki-anchor {
            display: none;
            margin-left: 6px;
            text-decoration: none;
        }

        a.wiki-anchor:hover {
            color: #aaa !important;
            text-decoration: none;
        }

        h1:hover a.wiki-anchor, h2:hover a.wiki-anchor, h3:hover a.wiki-anchor {
            display: inline;
            color: #ddd;
        }
    </style>
</head>
<body>
<a name="ARK-Identifiers"></a>
<h1>ARK Services<a href="#ARK-Identifiers" class="wiki-anchor">&para;</a></h1>


<ul class="toc right">
    <li><strong>Table of contents</strong></li>
    <li><a href="#Setting-up-Ark-creationbinding">Setting up Ark creation/binding</a>
        <ul>
            <li><a href="#Create-a-collection-of-Arks">Create a collection of Arks</a></li>
            <li><a href="#Select-a-Template">Select a Template:</a></li>
            <li><a href="#Ark-URL-structure">Ark URL structure:</a></li>
            <li><a href="#Delete-a-collection-of-Arks">Delete a collection of Arks</a></li>
            <li><a href="#Minting">Minting</a></li>
            <li><a href="#Bind-Set">Bind Set</a></li>
            <li><a href="#Bulk-Bind">Bulk Bind</a>
                <ul>
                    <li><a href="#Ingest-new-Ark">Ingest new Ark</a></li>
                    <li><a href="#Update-existing-Arks">Update existing Arks</a></li>
                </ul>
            </li>
            <li><a href="#Generate-reports">Generate reports</a></li>
        </ul>
    </li>
    <li><a href="#Resolver">Resolver</a></li>
    <li><a href="#Maintenance">Maintenance</a>
        <ul>
            <li><a href="#Database-backup">Database backup</a></li>
        </ul>
    </li>
</ul>


<a name="Setting-up-Ark-creationbinding"></a>
<h1>Setting up Ark creation/binding<a href="#Setting-up-Ark-creationbinding" class="wiki-anchor">&para;</a></h1>


<a name="Create-a-collection-of-Arks"></a>
<h2>Create a collection of Arks<a href="#Create-a-collection-of-Arks" class="wiki-anchor">&para;</a></h2>


<ul>
    <li>Visit: <a class="external" href="#/admin.php">http://{{ DOMAIN }}/admin.php</a>
    </li>
    <li>Fill out the "Create Database" form, then click Create.
        <ul>
            <li>
                <ins><strong>Note:</strong></ins>
                <span style="background:yellow;"> To ensure the sufficient of the Ark ID lookup for redirection, the prefix must be unique (already enforced) among multiple databases</span>.
            </li>
        </ul>
    </li>
</ul>


<p><img src="images/Screen%20Shot%202020-10-22%20at%203.12.29%20PM.png" style="width:80%;" alt=""/></p>


<a name="Select-a-Template"></a>
<h2>Select a Template:<a href="#Select-a-Template" class="wiki-anchor">&para;</a></h2>


<ul>
    <li><strong>.rddd</strong>: to mint random 3-digit numbers, stopping after 1000th</li>
    <li><strong>.sdddddd</strong>: to mint sequential 6-digit numbers, stopping after millionth</li>
    <li><strong>.zd</strong>: sequential numbers without limit, adding new digits as needed</li>
    <li><strong>bc.rdddd</strong>: random 4-digit numbers with constant prefix bc</li>
    <li><strong>8rf.sdd</strong>: sequential 2-digit numbers with constant prefix 8rf</li>
    <li><strong>.se</strong>: sequential extended-digits (from 0123456789bcdfghjkmnpqrstvwxz)</li>
    <li><strong>h9.reee</strong>: random 3-extended-digit numbers with constant prefix h9</li>
    <li><strong>.zeee</strong>: unlimited sequential numbers with at least 3 extended-digits</li>
    <li><strong>.rdedeedd</strong> : random 7-char numbers, extended-digits at chars 2, 4, and 5</li>
    <li><strong>.zededede</strong>: unlimited mixed digits, adding new extended-digits as needed</li>
    <li><strong>sdd.sdede</strong> : sequential 4-mixed-digit numbers with constant prefix sdd</li>
    <li><strong>.rdedk</strong> : random 3 mixed digits plus final (4th) computed check character</li>
    <li><strong>.sdeeedk</strong> : 5 sequential mixed digits plus final extended-digit check char</li>
    <li><strong>.zdeek</strong> : sequential digits plus check char, new digits added as needed</li>
    <li><strong>63q.redek</strong> : prefix plus random 4 mixed digits, one of them a check char</li>
</ul>


<a name="Ark-URL-structure"></a>
<h2>Ark URL structure:<a href="#Ark-URL-structure" class="wiki-anchor">&para;</a></h2>


<p><a class="external" href="https://wiki.lyrasis.org/display/ARKs/ARK+Identifiers+FAQ">https://wiki.lyrasis.org/display/ARKs/ARK+Identifiers+FAQ</a>
</p>


<hr/>


<a name="Delete-a-collection-of-Arks"></a>
<h2>Delete a collection of Arks<a href="#Delete-a-collection-of-Arks" class="wiki-anchor">&para;</a></h2>


<ol>
    <li>Go in phpMyadmin, then database name which was set at
        <ins><strong>$mysql_dbname</strong></ins>
        above
    </li>
    <li>Drop the table which enter in the previous step.</li>
    <li>Back to <a class="external" href="#/admin.php">http://{{ DOMAIN }}/admin.php</a>,
        refresh the page
        <ul>
            <li>
                <ins><strong>Note:</strong></ins>
                <span style="background:yellow;">Please avoid remove the system and user tables, otherwise, the current configuration will be lost, the installation step will be repeated</span>.
            </li>
        </ul>
    </li>
</ol>


<hr/>


<a name="Minting"></a>
<h2>Minting<a href="#Minting" class="wiki-anchor">&para;</a></h2>


<p><img src="images/Screen%20Shot%202020-10-19%20at%209.15.44%20AM.png" style="width:60%;" alt=""/></p>


<hr/>


<a name="Bind-Set"></a>
<h2>Bind Set<a href="#Bind-Set" class="wiki-anchor">&para;</a></h2>


<p><img src="images/Screen%20Shot%202020-10-19%20at%209.27.49%20AM.png" style="width:60%;" alt=""/> <img
        src="images/1054/Screen%20Shot%202020-10-19%20at%209.29.21%20AM.png" style="width:60%;" alt=""/></p>


<hr/>


<a name="Bulk-Bind"></a>
<h2><strong>Bulk Bind</strong><a href="#Bulk-Bind" class="wiki-anchor">&para;</a></h2>


<p><strong>Imported File format</strong>: CSV only.<br/><strong>Requirement</strong>: must have 3 mandatory columns:
    <ins>PID, URL, LOCAL_ID</ins>
    (already had CSV validation check in place)
</p>

<p><img src="images/Screen%20Shot%202020-10-30%20at%2010.11.20%20AM.png" style="width:60%;" alt=""/> <img
        src="images/1078/Screen%20Shot%202020-10-30%20at%2010.13.00%20AM.png" style="width:60%;" alt=""/></p>


<a name="Ingest-new-Ark"></a>
<h3>Ingest new Ark<a href="#Ingest-new-Ark" class="wiki-anchor">&para;</a></h3>


<ul>
    <li>Download this template <a class="external" href="#/template.csv">http://{{ DOMAIN }}/template.csv</a>
    </li>
    <li>Fill out 3 mandatory columns (Case insensitive), If this condition is not satisfied, the system won't proceed
        with uploading CSV
        <ul>
            <li>LOCAL_ID,</li>
            <li>PID,</li>
            <li>URL</li>
        </ul>
    </li>
    <li>Add more column for other metadata (if needed)</li>
    <li>Follow Bulk Bind steps above</li>
</ul>


<a name="Update-existing-Arks"></a>
<h3>Update existing Arks<a href="#Update-existing-Arks" class="wiki-anchor">&para;</a></h3>


<ul>
    <li>Download this template <a class="external" href="#/template.csv">http://{{ DOMAIN }}/template.csv</a>
    </li>
    <li>Fill out 3 mandatory columns (Case insensitive), If this condition is not satisfied, the system won't proceed
        with uploading CSV
        <ul>
            <li>LOCAL_ID,</li>
            <li>PID,</li>
            <li>URL</li>
        </ul>
    </li>
    <li>Add Ark_ID column <strong>
        <ins>(<span
                style="background:yellow;"> Note: make sure they are existed or minted before preparing the CSV</span>)
        </ins>
    </strong></li>
    <li>Add more column for other metadata (if needed)</li>
    <li>Follow Bulk Bind steps above</li>
</ul>


<hr/>


<a name="Generate-reports"></a>
<h2>Generate reports<a href="#Generate-reports" class="wiki-anchor">&para;</a></h2>


<p><img src="images/Screen%20Shot%202020-10-22%20at%203.53.37%20PM.png" style="width:80%;" alt=""/></p>


<hr/>

<a name="Resolver"></a>
<h1>Resolver<a href="#Resolver" class="wiki-anchor">&para;</a></h1>


<p><strong>Step 1</strong>. Catch coming traffic and detect Ark URL. In <strong>.htaccess</strong> at the root
    directory, obtain Ark ID information and redirect to resolver.php:</p>


<pre>
RewriteEngine On
RewriteCond %{REQUEST_URI}  ^/ark:/.*$
#RewriteRule ^(.*)$ /dsu_noid4php/$1 [L]
RewriteRule ^(.*)$ /resolver.php?q=$1 [L]
</pre>

<p><strong>Step 2</strong>. Captured Ark ID from URL. ie. <a class="external"
                                                             href="#/ark:/61220/utsc6">http://{{ DOMAIN }}/ark:/61220/utsc6</a>
    (which is 61220/utsc6)<br/><strong>Step 3</strong>, Get prefix ('utsc' from example above), from this prefix,
    identify which database to lookup the object bound to this ARK ID (This is why the prefix need to be
    unique)<br/><strong>Step 4</strong>. Look for field URL first, if URL is valid, redirect to that URL<br/><strong>Step
        5</strong>. If field URL is not available, use PID instead, establishing the URL by combine <strong>https + NAA
        + PID</strong></p>


<p><strong>resolver.php:</strong> <br/>
<pre>
<code class="php syntaxhl"><span class="CodeRay">  <span class="local-variable">$uid</span> = <span class="predefined">str_replace</span>(<span
        class="string"><span class="delimiter">&quot;</span><span class="content">ark:/</span><span class="delimiter">&quot;</span></span>, <span
        class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>, <span
        class="predefined">$_GET</span>[<span class="string"><span class="delimiter">'</span><span
        class="content">q</span><span class="delimiter">'</span></span>]);

    <span class="comment">// get all database Ark related</span>
    <span class="local-variable">$arkdbs</span> = <span class="constant">Database</span>::showArkDatabases();
    <span class="comment">// only proceed if already have ark_core db</span>To update reCAPTCHA settings
    <span class="keyword">if</span> (<span class="predefined">is_array</span>(<span
            class="local-variable">$arkdbs</span>) &#38;&#38; <span class="predefined">count</span>(<span
            class="local-variable">$arkdbs</span>) &gt; <span class="integer">0</span>) {
        <span class="local-variable">$url</span>  = <span class="string"><span class="delimiter">&quot;</span><span
            class="delimiter">&quot;</span></span>;
        <span class="constant">GlobalsArk</span>::<span class="local-variable">$db_type</span> = <span
            class="string"><span class="delimiter">'</span><span class="content">ark_mysql</span><span
            class="delimiter">'</span></span>;

        <span class="comment">// loop through database and find matching one with prefix</span>
        <span class="keyword">foreach</span> (<span class="local-variable">$arkdbs</span> <span
            class="keyword">as</span> <span class="local-variable">$db</span>) {
            <span class="keyword">try</span> {
                <span class="comment">// if ark ID found, look for URL fields first.</span>
                <span class="local-variable">$results</span> = rest_get(<span class="string"><span class="delimiter">&quot;</span><span
            class="content">/rest.php?db=</span><span class="local-variable">$dbx</span><span class="content">%x%op=url&#38;ark_id=</span><span
            class="local-variable">$uid</span><span class="delimiter">&quot;</span></span>);
                <span class="local-variable">$results</span> = json_decode(<span class="local-variable">$results</span>);

                <span class="keyword">if</span>(<span class="predefined">count</span>(<span class="local-variable">$results</span>) &lt;= <span
            class="integer">0</span> ) {
                    <span class="comment">// if URL field is empty, go with the PID</span>
                    <span class="local-variable">$results</span> = rest_get(<span class="string"><span
            class="delimiter">&quot;</span><span class="content">/rest.php?db=</span><span
            class="local-variable">$dbx</span><span class="content">%x%op=pid&#38;ark_id=</span><span
            class="local-variable">$uid</span><span class="delimiter">&quot;</span></span>);
                    <span class="local-variable">$results</span> = json_decode(<span
            class="local-variable">$results</span>);
                    <span class="keyword">if</span> (<span class="predefined">count</span>(<span class="local-variable">$results</span>) &gt; <span
            class="integer">0</span>) {
                        <span class="local-variable">$dns</span> = json_decode(rest_get(<span class="string"><span
            class="delimiter">&quot;</span><span class="content">/rest.php?db=</span><span
            class="local-variable">$dbx</span><span class="content">%x%op=naa</span><span
            class="delimiter">&quot;</span></span>));
                        <span class="local-variable">$url</span> = <span class="string"><span
            class="delimiter">&quot;</span><span class="content">https://</span><span class="local-variable">$dns</span><span
            class="content">/islandora/object/</span><span class="delimiter">&quot;</span></span>. <span
            class="local-variable">$results</span>[<span class="integer">0</span>]-&gt;{<span class="string"><span
            class="delimiter">'</span><span class="content">_value</span><span class="delimiter">'</span></span>};
                        <span class="keyword">break</span>;
                    }
                    <span class="keyword">else</span> {
                        <span class="local-variable">$url</span> = <span class="string"><span
            class="delimiter">&quot;</span><span class="content">/404.php</span><span
            class="delimiter">&quot;</span></span>;
                    }
                }
                <span class="keyword">else</span> {
                    <span class="local-variable">$url</span> = <span class="local-variable">$results</span>[<span
            class="integer">0</span>]-&gt;{<span class="string"><span class="delimiter">'</span><span class="content">_value</span><span
            class="delimiter">'</span></span>};
                    <span class="keyword">break</span>;
                }

            } <span class="keyword">catch</span> (<span class="constant">RequestException</span> <span
            class="local-variable">$e</span>) {
                logging(<span class="local-variable">$e</span>-&gt;getMessage());
                <span class="local-variable">$url</span> = <span class="string"><span
            class="delimiter">&quot;</span><span class="content">/404.php</span><span
            class="delimiter">&quot;</span></span>;
            }

        }
        <span class="predefined">header</span>(<span class="string"><span class="delimiter">&quot;</span><span
            class="content">Location: </span><span class="local-variable">$url</span><span
            class="delimiter">&quot;</span></span>);
    }
</span></code><br/></pre>
</p>


<hr/>


<a name="Maintenance"></a>
<h1>Maintenance<a href="#Maintenance" class="wiki-anchor">&para;</a></h1>


<a name="Database-backup"></a>
<h2>Database backup<a href="#Database-backup" class="wiki-anchor">&para;</a></h2>


<p>coming soon.</p>
</body>
</html>
